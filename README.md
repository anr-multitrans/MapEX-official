# MapEX-official

Author: RÃ©my Sun

Official repository for the WACV 2025 paper [Mind the map! Accounting for existing map information when estimating online HDMaps from sensor](https://arxiv.org/abs/2311.10517)

**This is a pre-release of the code to elucidate any questions regarding the implementation that arise after publication of MapEX at WACV 2025**

A proper full release of standalone cleaned code along with weights, an example mapmodex map and better explainations will be released as soon as possible!

## Quick start

This repository currently contains two directories: project and tools.

The MapEX code was built on top of the MapTRv2 [code](https://github.com/hustvl/MapTR/tree/maptrv2), precisely this [commit](https://github.com/hustvl/MapTR/tree/6aacba765e8d574df25f3e05be9cadce7dd8b58e) from August 31, 2023

This repository's two folders replace the corresponding folders in the MapTRv2 code. Follow the MapTRv2 installation instructions (MapEX does not change anything to installation).

MapEX runs can be launched in a similar fashion to MapTRv2 code using one of the configs provided in this code dump (to be run on 2 gpus):

``./tools/dist_train.sh projects/configs/mapcr/final_mapcr_gthybrid_noisy5_nusc_r50_ep24_2gpusqrt_run0.py 2 28523 --seed=0``

This will require a map generated by the companion map modification code [MapModEX](https://github.com/anr-multitrans/MapModEX-official).

## Understanding the code

MapEX only changes a few elements of the MapTRv2 code pipeline. MapTRv2 itself works by adding additional modules to the mmdetection3d library (code is contained in projects/mmdet3d_plugin)

The main changes made to MapTRv2 are limited to the following:
- Lines 388 to 428 in ``projects/mmdet3d_plugin/maptr/dense_heads/mapcr_head.py``: ("self.query_embed_type == 'gt_hybrid_pts'") shows how queries are built in MapEX (you can compare to the MapTR way Lines 304 to 307). Encoding the existing map in particular is done Lines 389 to 405: gt_bboxes refers to elements of the "existing map".
- Lines 649 to 700 in ``projects/mmdet3d_plugin/maptr/dense_heads/mapcr_head.py``: element pre-attribution is computed using pre-computed gt_correspondence. For each element, a number points to the corresponding ground truth map element, -1 indicates no correspondance.
- Generally speaking, all the architecture code is in projects/mmdet3d_plugin/maptr/, with models in projects/mmdet3d_plugin/maptr/detectors/ and the sub-modules these models use. there are three variants of model code: maptr, maptrv2 et mapcr. MapEX corresponds to the mapcr model.
- projects/mmdet3d_plugin/datasets/nuscenes_offlinemap_dataset.py: contains the data loading, formatting and processing code (modified maps are built with MapModEX before this).
